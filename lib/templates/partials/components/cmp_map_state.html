<div class="locations-mapbox">
    <div id="choose-mapinfo-{{map_state}}" class="locations-info">
        <p>This map will be powered by cached data from the NEXUS <code>/products/postal-codes/{postal-code}</code> API call on the live site. The only map with coloring on ChooseUX is Rhode Island.</p>
    </div>
    <div id="choose-map-{{map_state}}" class="locations-map map">
        <h3 class="locations-map-state">Zipcodes We Serve in {{map_state_long}}</h3>
    </div>
    <script>

document.addEventListener('DOMContentLoaded', function() {
    var width = document.getElementById('choose-map-{{map_state}}').offsetWidth;
    var height = document.getElementById('choose-map-{{map_state}}').offsetHeight;
    var centered;

    var projection = d3.geo.albers();

    var path = d3.geo.path()
        .projection(projection);
    var svg = d3.select("#choose-map-{{map_state}}").append("svg")
        .attr("class", "map-svg")
        .attr("viewBox", "0 0 " + width + " " + height)
        .attr("width", width)
        .attr("height", height);
    svg.append("rect")
        .attr("class", "map-base")
        .attr("width", width)
        .attr("height", height);

    var stateMap = svg.append("g");
    var stateBounds;
    var stateScaling;
    var stateTranslation;

    d3.json("/data/states/states/{{map_state}}-states.json", function(error, state) {

        var stateFeature = topojson.feature(state, state.objects.states);

        projection
          .scale(1)
          .translate([0, 0]);

        stateBounds = path.bounds(stateFeature);
        stateScaling = 0.75 / Math.max((stateBounds[1][0] - stateBounds[0][0]) / width, (stateBounds[1][1] - stateBounds[0][1]) / height);
        stateTranslation = [(width - stateScaling * (stateBounds[1][0] + stateBounds[0][0])) / 2, (height - stateScaling * (stateBounds[1][1] + stateBounds[0][1])) / 2];

        projection
          .scale(stateScaling)
          .translate(stateTranslation);

        stateMap.append("g")
            .selectAll("path")
            .data(stateFeature.features)
            .enter()
            .append("path")
            .attr("d", path)
            .attr("class", function(d) {
                return 'map-states';
            });

        d3.json("/data/states/zipcodes/{{map_state}}-zipcodes.json", function(error, stateZips) {

            var stateZipsFeature = topojson.feature(stateZips, stateZips.objects.zipcodes);

            projection
              .scale(1)
              .translate([0, 0]);

            projection
              .scale(stateScaling)
              .translate(stateTranslation);

            stateMap.append("g")
                .selectAll("path")
                .data(stateZipsFeature.features)
                .enter()
                .append("path")
                .attr("d", path)
                .attr("class", function(d) {
                    if (d.properties.blue || d.properties.green || d.properties.orange === 1) {
                        if (d.properties.green === 1) {
                            console.log(d.properties.name + " is green!");
                            return "map-green";
                        }
                        if (d.properties.orange === 1) {
                            console.log(d.properties.name + " is orange!");
                            return "map-orange";
                        }
                        if (d.properties.blue === 1) {
                            console.log(d.properties.name + " is blue!");
                            return "map-blue";
                        }
                    } else {
                        //console.log(d.properties.name + " is not colorized");
                        return "map-zips";
                    }
                })
                .on('click', clicked)
                .on('mouseover', function(d,i) {
                    d3.select(this)
                        .classed("map-highlight", true);
                    d3.select("#choose-map-{{map_state}} .locations-map-state").text(d.properties.name);
                })
                .on('mouseout', function(d,i) {
                    d3.select(this)
                        .classed("map-highlight", false);
                    d3.select("#choose-map-{{map_state}} .locations-map-state").text("Zipcodes We Serve in {{map_state_long}}");
                });
        });
    });
    function clicked(d) {
        var x, y, k;
        if (d && centered !== d) {
            var centroid = path.centroid(d);
            x = centroid[0];
            y = centroid[1];
            k = 3;
            centered = d;
            d3.select('#choose-mapinfo-{{map_state}}-state').text(d.properties.name);
        } else {
            x = width / 2;
            y = height / 2;
            k = 1;
            centered = null;
            d3.select('#choose-mapinfo-{{map_state}}-state').text("{{map_state}}");
        }

        stateMap.selectAll("path")
            .classed("map-highlight", centered && function(d) {
                return d === centered;
            });

    stateMap.transition()
        .duration(750)
        .attr("transform", "translate(" + width / 2 + "," + height / 2 + ")scale(" + k + ")translate(" + -x + "," + -y + ")")
        .style("stroke-width", 1.5 / k + "px");

    }
});
    </script>
</div>
